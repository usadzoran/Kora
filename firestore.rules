rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'admin@tournament.com';
    }

    function isOwner(teamId) {
      return isAuthenticated() && request.auth.uid == teamId;
    }

    // --- COLLECTIONS ---

    // Teams: Anyone can read, anyone can create (register), only owner or admin can update/delete
    match /teams/{teamId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isOwner(teamId) || isAdmin();
    }
    
    // News, Matches, Ads, Channels: Public read, Admin write
    match /news/{newsId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /matches/{matchId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /site_ads/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /channels/{channelId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Posts: Public read, authenticated coaches can create, owners can edit/delete
    match /posts/{postId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.teamId) || isAdmin();
      // Allow specific field update for likes from any authenticated user
      allow update: if isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    // Messages: Only accessible by the sender or receiver
    match /messages/{messageId} {
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid ||
        isAdmin()
      );
    }

    // Challenges: Public read, authenticated users can join (create), admin manages
    match /challenges/{challengeId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isOwner(resource.data.teamId);
    }

    // Settings & Stats
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
      // Allow public to increment visitorCount in stats
      allow update: if settingId == 'stats' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['visitorCount']);
    }
    
    // Team Photos
    match /team_photos/{photoId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.teamId) || isAdmin();
    }

    // Default deny for anything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}